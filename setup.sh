#!/bin/bash

apt-get update
curl -fsSL https://deb.nodesource.com/setup_14.x | bash -
apt-get install nodejs clamav clamav-daemon -y
npm install
echo "TCPSocket 3310" >> /etc/clamav/clamd.conf
echo "TCPAddr 127.0.0.1" >> /etc/clamav/clamd.conf
mkdir /unscanned_files

#########################################################
# Node.jsのUnitファイルの作成
#########################################################
cat <<EOF > /lib/systemd/system/malware-scanner.service
[Unit]
Description=Malware Scanner Service
Documentation=https://github.com/gashirar/gcs-malware-scanner
After=network.target

[Service]
Environment=PORT=8080
Environment=UNSCANNED_BUCKET=<Your Bucket>
Environment=CLEAN_BUCKET=<Your Bucket>
Environment=QUARANTINED_BUCKET=<Your Bucket>
Type=simple
User=root
ExecStart=/usr/bin/node /app/server.js
Restart=on-failure

[Install]
WantedBy=multi-user.target

EOF

#########################################################
# Google Cloud Logging Agentのインストール
#########################################################
curl -sSO https://dl.google.com/cloudagents/add-google-cloud-ops-agent-repo.sh
sudo bash add-google-cloud-ops-agent-repo.sh --also-install

#########################################################
# systemctl
#########################################################
systemctl enable malware-scanner
systemctl daemon-reload
systemctl restart clamav-daemon
systemctl restart clamav-freshclam
