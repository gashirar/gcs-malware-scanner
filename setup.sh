#!/bin/bash

apt-get update
curl -fsSL https://deb.nodesource.com/setup_14.x | bash -
apt-get install nodejs clamav clamav-daemon -y
npm install
freshclam
echo "TCPSocket 3310" >> /etc/clamav/clamd.conf
echo "TCPAddr 127.0.0.1" >> /etc/clamav/clamd.conf
mkdir /unscanned_files

#########################################################
# Node.jsのUnitファイルの作成
#########################################################
cat <<EOF > /lib/systemd/system/malware-scanner.service
[Unit]
Description=Malware Scanner Service
Documentation=https://github.com/gashirar/gcs-malware-scanner
After=network.target

[Service]
Environment=PORT=8080
Environment=UNSCANNED_BUCKET=<Your Bucket>
Environment=CLEAN_BUCKET=<Your Bucket>
Environment=QUARANTINED_BUCKET=<Your Bucket>
Type=simple
User=root
ExecStart=/usr/bin/node /app/server.js
Restart=on-failure

[Install]
WantedBy=multi-user.target

#########################################################
# Google Cloud Logging Agentのインストール
#########################################################
curl -sSO https://dl.google.com/cloudagents/add-logging-agent-repo.sh
bash add-logging-agent-repo.sh --also-install

#########################################################
# 設定ファイル
#########################################################
systemctl daemon-reload

#########################################################
# ClamAV
#########################################################
freshclam
service clamav-daemon force-reload
service clamav-freshclam force-reload